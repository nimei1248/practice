----------------------------------optimize before---------------------------------------
SQL> desc 
SELECT 
    t2.login_name, t1.customer_id, t2.head_img_url, t1.amount
FROM
    (SELECT 
        *
    FROM
        (SELECT 
        SUM(t.bonus_amount) amount, t.customer_id customer_id
    FROM
        t_customer t
    WHERE
        t.product_id = 'bike'
            AND t.report_date >= '2019-08-01 00:00:00'
            AND t.report_date <= '2019-08-21 19:06:02'
    GROUP BY t.customer_id) tt
    ORDER BY tt.amount DESC
    LIMIT 0 , 100) t1,
    (SELECT 
        *
    FROM
        t_third
    WHERE
        id IN (SELECT 
                MAX(id)
            FROM
                t_third
            GROUP BY customer_id)) t2
WHERE
    t1.customer_id = t2.customer_id
ORDER BY amount DESC;
+----+-------------+-------------------+------------+-------+---------------+-------+---------+----------------+---------+----------+-----------------------------------------------------------+
| id | select_type | table             | partitions | type  | possible_keys | key   | key_len | ref            | rows    | filtered | Extra                                                     |
+----+-------------+-------------------+------------+-------+---------------+-------+---------+----------------+---------+----------+-----------------------------------------------------------+
|  1 | PRIMARY     | <derived2>        | NULL       | ALL   | NULL          | NULL  | NULL    | NULL           |     100 |   100.00 | Using filesort                                            |
|  1 | PRIMARY     | t_third | NULL    | ref        | i_aaa         | i_aaa | 152   | t1.customer_id           |       3 |   100.00 | Using where                                               |
|  5 | SUBQUERY    | t_third | NULL    | index      | i_bbb,i_aaa   | i_aaa | 169   | NULL                     | 1661304 |   100.00 | Using index                                               |
|  2 | DERIVED     | <derived3>        | NULL       | ALL   | NULL          | NULL  | NULL    | NULL           |   22481 |   100.00 | Using filesort                                            |
|  3 | DERIVED     | t                 | NULL       | range | i_aaa,i_bbb   | i_bbb | 22      | NULL           |   22481 |   100.00 | Using where; Using index; Using temporary; Using filesort |
+----+-------------+-------------------+------------+-------+---------------+-------+---------+----------------+---------+----------+-----------------------------------------------------------+
5 rows in set, 1 warning (0.00 sec)

SQL> show warnings\G
*************************** 1. row ***************************
  Level: Note
   Code: 1003
Message: /* select#1 */ select `db1`.`t_third`.`login_name` AS `login_name`,`t1`.`customer_id` AS `customer_id`,`db1`.`t_third`.`head_img_url` AS `head_img_url`,`t1`.`amount` AS `amount` from (/* select#2 */ select `tt`.`amount` AS `amount`,`tt`.`customer_id` AS `customer_id` from (/* select#3 */ select sum(`db1`.`t`.`bonus_amount`) AS `amount`,`db1`.`t`.`customer_id` AS `customer_id` from `db1`.`t_customer` `t` where ((`db1`.`t`.`product_id` = 'bike') and (`db1`.`t`.`report_date` >= '2019-08-01 00:00:00') and (`db1`.`t`.`report_date` <= '2019-08-21 19:06:02')) group by `db1`.`t`.`customer_id`) `tt` order by `tt`.`amount` desc limit 0,100) `t1` join `db1`.`t_third` where ((`db1`.`t_third`.`customer_id` = `t1`.`customer_id`) and <in_optimizer>(`db1`.`t_third`.`id`,`db1`.`t_third`.`id` in ( <materialize> (/* select#5 */ select max(`db1`.`t_third`.`id`) from `db1`.`t_third` group by `db1`.`t_third`.`customer_id` having 1 ), <primary_index_lookup>(`db1`.`t_third`.`id` in <temporary table> on <auto_key> where ((`db1`.`t_third`.`id` = `materialized-subquery`.`MAX(id)`)))))) order by `t1`.`amount` desc
1 row in set (0.00 sec)

runtime 0.6s


----------------------------------optimized---------------------------------------
SQL> desc 
SELECT 
    (SELECT 
            t2.login_name
        FROM
            t_third t2
        WHERE
            t1.customer_id = t2.customer_id
        ORDER BY id DESC
        LIMIT 1) login_name,
    t1.customer_id,
    (SELECT 
            t2.head_img_url
        FROM
            t_third t2
        WHERE
            t1.customer_id = t2.customer_id
        ORDER BY id DESC
        LIMIT 1) head_img_url,
    t1.amount
FROM
    (SELECT 
        *
    FROM
        (SELECT 
        SUM(t.bonus_amount) amount, t.customer_id customer_id
    FROM
        t_customer t
    WHERE
        t.product_id = 'bike'
            AND t.report_date >= '2019-08-01 00:00:00'
            AND t.report_date <= '2019-08-21 19:06:02'
    GROUP BY t.customer_id ORDER BY BULL) tt
    ORDER BY tt.amount DESC
    LIMIT 0,100) t1;
+----+--------------------+------------+------------+-------+---------------+-------+---------+----------------+-------+----------+-----------------------------------------------------------+
| id | select_type        | table      | partitions | type  | possible_keys | key   | key_len | ref            | rows  | filtered | Extra                                                     |
+----+--------------------+------------+------------+-------+---------------+-------+---------+----------------+-------+----------+-----------------------------------------------------------+
|  1 | PRIMARY            | <derived4> | NULL       | ALL   | NULL          | NULL  | NULL    | NULL           |   100 |   100.00 | NULL                                                      |
|  4 | DERIVED            | <derived5> | NULL       | ALL   | NULL          | NULL  | NULL    | NULL           | 22477 |   100.00 | Using filesort                                            |
|  5 | DERIVED            | t          | NULL       | range | i_aaa,i_bbb   | i_bbb | 22      | NULL           | 22477 |   100.00 | Using where; Using index; Using temporary; Using filesort |
|  3 | DEPENDENT SUBQUERY | t2         | NULL       | ref   | i_aaa         | i_aaa | 152     | t1.customer_id |     3 |   100.00 | Using index condition; Using filesort                     |
|  2 | DEPENDENT SUBQUERY | t2         | NULL       | ref   | i_aaa         | i_aaa | 152     | t1.customer_id |     3 |   100.00 | Using index condition; Using filesort                     |
+----+--------------------+------------+------------+-------+---------------+-------+---------+----------------+-------+----------+-----------------------------------------------------------+
5 rows in set, 3 warnings (0.00 sec)


SQL> show warnings\G
*************************** 1. row ***************************
  Level: Note
   Code: 1276
Message: Field or reference 't1.customer_id' of SELECT #2 was resolved in SELECT #1
*************************** 2. row ***************************
  Level: Note
   Code: 1276
Message: Field or reference 't1.customer_id' of SELECT #3 was resolved in SELECT #1
*************************** 3. row ***************************
  Level: Note
   Code: 1003
Message: /* select#1 */ select (/* select#2 */ select `db1`.`t2`.`login_name` from `db1`.`t_third` `t2` where (`t1`.`customer_id` = `db1`.`t2`.`customer_id`) order by `db1`.`t2`.`id` desc limit 1) AS `login_name`,`t1`.`customer_id` AS `customer_id`,(/* select#3 */ select `db1`.`t2`.`head_img_url` from `db1`.`t_third` `t2` where (`t1`.`customer_id` = `db1`.`t2`.`customer_id`) order by `db1`.`t2`.`id` desc limit 1) AS `head_img_url`,`t1`.`amount` AS `amount` from (/* select#4 */ select `tt`.`amount` AS `amount`,`tt`.`customer_id` AS `customer_id` from (/* select#5 */ select sum(`db1`.`t`.`bonus_amount`) AS `amount`,`db1`.`t`.`customer_id` AS `customer_id` from `db1`.`t_customer` `t` where ((`db1`.`t`.`product_id` = 'bike') and (`db1`.`t`.`report_date` >= '2019-08-01 00:00:00') and (`db1`.`t`.`report_date` <= '2019-08-21 19:06:02')) group by `db1`.`t`.`customer_id`) `tt` order by `tt`.`amount` desc limit 0,100) `t1`
3 rows in set (0.00 sec)

runtime 0.06s

