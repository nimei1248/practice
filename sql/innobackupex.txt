lession14

xtrabackup在线热备

根据mysql的版本选择xtrabackup版本
5.7新特性: redo log size、undo分离、tablespace使用这些新功能注意对备份恢复是否有影响

部署
1.下载安装
重要的命令
innobackupex
xtrabackup

2.备份的前提
创建一个备份用的账户；
create user ‘bkuser’@‘localhost’ identified by ‘xxx’;
grant reload,lock tables,process,replication client on *.* to ‘bkuser’@‘localhost’;
flush privileges;

3.全备及恢复
innobackupex —user=bkuser —password=xxx /data/backup/  目录会自己创建
completed OK 出现这个表示备份成功

innobackupex —user=bkuser —password=xxx /data/backup/   &> | tee 1.log
2>&1 | tee 1.log

可以看到备份的位置
按日期目录进行备份的
备份的文件：
配置文件 my.cnf
库名
系统表空间ibdata1
ib_buffer_pool
xtrabackup_binlog_info   binlog信息
xtrabackup_checkpoints 检查点
xtrabackup_info
xtrabackup_logfile

cat xtrabackup_info  备份的信息
备份花费的时间等信息

恢复：需要停止mysql
innobackupex —apply-log /data/backup/2016-09-18_11-03-36/
completed OK 出现这个表示恢复成功
此步骤是应用redo log做crash recovery过程

对比恢复与备份后的目录中文件的差异
恢复后的目录就可以作为data启动

将mydata重命名模拟删除
怎么恢复？
进入相应的目录
cd /mysqldata/3306
mv mydata mydata-2017
rm -rf mydata
mkdir mydata
chown 
innobakcupex —copy-back /data/backup/2016-09-18_11-03-36/
自动生成data目录
修改权限

auto.cnf是启动的时候自己创建的，inobackupex备份的也有，建议用新产生的

方法2:
删除mydata binlog/*
mkdir mydata
cp -a /data/backup/2016-09-18_11-03-36/ mydata/
chown
启动

备份时指定目录方法：
innobackupex —user=bkuser —password=xxx —no-timestamp /data/backup/db-3306-full-2017
恢复的方式一样：先apply-log 再—copy-back


根据全备份做个从库：

